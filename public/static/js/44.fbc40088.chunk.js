(this["webpackJsonpnew-chiji-front-end"]=this["webpackJsonpnew-chiji-front-end"]||[]).push([[44],{547:function(e,t,n){"use strict";n.r(t),n.d(t,"socket",(function(){return l}));var i=n(27),s=n(282),a=n.n(s),r=n(1),o=n(749),c=n.n(o),f=n(45),u=n(56),d=n(283),l="";t.default=function(){var e=Object(u.useDispatch)(),t=Object(f.h)(),n=Object(u.useSelector)((function(e){return e.chat})),s=n.chatList,o=n.loadedAgents,m=n.agents,g=(n.otherChatList,n.ids),v=n.createdChatList,h=n.savedIds,p=n.newChat,b=function(){return a.a.async((function(e){for(;;)switch(e.prev=e.next){case 0:if(!l||!l.connected){e.next=4;break}return e.abrupt("return",l);case 4:return l=c()(f.a,{forceNew:!0,reconnection:!0,reconnectionAttempts:1/0,transports:["websocket","polling"]}),e.next=7,a.a.awrap(x());case 7:case"end":return e.stop()}}))};Object(r.useEffect)((function(){a.a.async((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,a.a.awrap(e(Object(d.u)()));case 2:case"end":return t.stop()}}))}),[]),Object(r.useEffect)((function(){Object(f.j)()&&b()}),[b]);var j=function(e){l.emit("event-mark-message-as-delivered",{mid:e})},O=function(e){if("Notification"in window){if("granted"===Notification.permission)new Notification("".concat(e.sender.name,": ").concat(e.content));else if("denied"!==Notification.permission)try{Notification.requestPermission().then((function(){new Notification("".concat(e.sender.name,": ").concat(e.content))}))}catch(t){if(!(t instanceof TypeError))throw t;Notification.requestPermission((function(){new Notification("".concat(e.sender.name,": ").concat(e.content))}))}}else Object(f.l)({type:"danger",title:"Push Notification",message:"This browser does not support push notification, Please update your browser"})},w=function(e,t){console.log("creating chatlist -----------------\x3e"),console.log("chatList ->",s,"type",t);var n,i,a=s;if("received"===t){for(var r=0;r<a.length;r++)if(a[r].id===e.from){n=a[r],a.splice(r,1);break}}else for(var o=0;o<a.length;o++)if(a[o].id===e.to){n=a[o],a.splice(o,1);break}n?(i=n.id,0===n.messages.filter((function(t){return e.mid===t.mid})).length&&n.messages.unshift(e)):e&&(n="received"===t?{id:e.sender.id,name:e.sender.name,avatar:e.sender.avatar,roleId:e.sender.roleId,messages:[e]}:{id:e.receiver.id,name:e.receiver.name,avatar:e.receiver.avatar,roleId:e.receiver.roleId,messages:[e]});var c=[];console.log("user msgs ----------\x3e",n),a.unshift(n),a.map((function(e){return c.push(e.id)})),a=a.reverse(),i&&I(i,n.messages)};Object(r.useEffect)((function(){(o&&v&&h||p)&&function(){var n;a.a.async((function(i){for(;;)switch(i.prev=i.next){case 0:n=[],m&&m.online&&m.online.filter((function(e){return e.id!==t.id&&1!==e.roleId&&-1===g.indexOf(e.id)})).map((function(e){return n.push({id:e.id,name:e.name,avatar:e.avatar,roleId:e.roleId,status:"online",messages:[]})})),m&&m.offline&&m.offline.filter((function(e){return e.id!==t.id&&1!==e.roleId&&-1===g.indexOf(e.id)})).map((function(e){return n.push({id:e.id,name:e.name,avatar:e.avatar,roleId:e.roleId,status:"offline",messages:[]})})),n.length&&e(Object(d.T)({otherChatList:n}));case 4:case"end":return i.stop()}}))}()}),[o&&v&&h||p]);var I=function(t,n){if(!n){var i=s.filter((function(e){return t===e.id}))[0];n=i&&i.messages||[]}e(Object(d.V)({messages:n}))},x=function(){var n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0;l.on("connected",(function(){var e={userId:t.id,lastMessageId:n};l.emit("event-initialization",e)})),l.on("emit-receive-message",(function(e){e.message.status<2&&e.message.from!==t.id&&(O(e.message),j(e.message.mid)),e.message.from===t.id?w(e.message,"sent"):w(e.message,"received")})),l.on("emit-receive-message-in-bulk",(function(t){var n;if(!Object(f.i)(t)&&t.recipient)t.list.length&&(n=s.find((function(e){return e.id===t.recipient})).messages).unshift.apply(n,Object(i.a)(t.list));else if(!Object(f.i)(t)&&t.list.length){var a=[];t.list.map((function(e){e.status="online",a.push(e.id)}));var r=t.list.reverse();e(Object(d.S)({ids:a})),e(Object(d.U)({chatList:r}))}else Object(f.i)(t)||t.list.length||e(Object(d.W)())})),l.on("emit-agent-status",(function(e){})),l.on("emit-message-sent",(function(e){console.log("on emit message sent -----------\x3e",e),w(e.message,"sent")})),l.on("emit-error",(function(e){console.log("emit - error",e);var t=Object(f.g)();l.emit("event-authentication",{token:t})}))};return null}},759:function(e,t){}}]);
//# sourceMappingURL=44.fbc40088.chunk.js.map